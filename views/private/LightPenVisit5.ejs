<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Free Drawing Demo</title>
    <style>
      body {
        margin-top:5pc;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <div class="container mt-5 p-5">
      <h2>Konva Free Drawing Demo</h2>
      <div id="container"></div>
      <div class="mt-3">
          <label for="tool">Select Tool:</label>
          <select id="tool">
              <option value="brush">Brush</option>
              <option value="eraser">Eraser</option>
          </select>
          <button class="btn btn-primary ml-2" onclick="saveImage()">Save Image</button>
          <input type="file" id="file-input" class="ml-2">
          <button class="btn btn-secondary ml-2" onclick="loadImage()">Load Image</button>
      </div>
  </div>

      <script>
      // var width = window.innerWidth;
      // var height = window.innerHeight - 25;
      var width = 900;
      var height = 500;

      // first we need Konva core things: stage and layer
      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height,
        createImageBitmap
      });

      var layer = new Konva.Layer();
      stage.add(layer);
    
      var isPaint = false;
      var mode = 'brush';
      var lastLine;

      stage.on('mousedown touchstart', function (e) {
        isPaint = true;
        var pos = stage.getPointerPosition();
        lastLine = new Konva.Line({
          stroke: '#df4b26',
          strokeWidth: 5,
          globalCompositeOperation:
            mode === 'brush' ? 'source-over' : 'destination-out',
          // round cap for smoother lines
          lineCap: 'round',
          lineJoin: 'round',
          // add point twice, so we have some drawings even on a simple click
          points: [pos.x, pos.y, pos.x, pos.y],
        });
        layer.add(lastLine);
      });

      stage.on('mouseup touchend', function () {
        isPaint = false;
      });

      // and core function - drawing
      stage.on('mousemove touchmove', function (e) {
        if (!isPaint) {
          return;
        }

        // prevent scrolling on touch devices
        e.evt.preventDefault();

        const pos = stage.getPointerPosition();
        var newPoints = lastLine.points().concat([pos.x, pos.y]);
        lastLine.points(newPoints);
      });

      var select = document.getElementById('tool');
      select.addEventListener('change', function () {
        mode = select.value;
      });
      
       // Save the image to localStorage
       function saveImage() {
            var dataURL = stage.toDataURL();
            localStorage.setItem('savedImage', dataURL);
            alert('Image saved successfully!');
        }

        // Load the image from localStorage
        function loadImage() {
            var savedImage = localStorage.getItem('savedImage');
            if (savedImage) {
                var imageObj = new Image();
                imageObj.src = savedImage;
                imageObj.onload = function () {
                    var konvaImage = new Konva.Image({
                        image: imageObj,
                        x: 0,
                        y: 0,
                    });
                    layer.add(konvaImage);
                    layer.batchDraw();
                };
            } else {
                alert('No saved image found.');
            }
        }
    </script>
    <button class="flex-column flex-grow-1" type="button" onclick="">click me!</button>
  </body>
</html>